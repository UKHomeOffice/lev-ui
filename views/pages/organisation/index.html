{% extends "app-template.njk" %}

{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}

{% set govukServiceNameKey = translate("pages.user-management.serviceName") %}
{% set hmpoPageKey = "user-management.organisationPage" %}
{% set govukServiceUrl = "/admin/organisations" %}

{% block hmpoContent %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    {% block mainContent %}
    <h1 id="header" data-page="{{hmpoPageKey}}">{{ translate("pages." + hmpoPageKey + ".h1", { default: hmpoTitle }) |
      safe }}: {{orgInfo.name}}</h1>
    <h3>Organisation Team(s)</h3>
    {% set teamHeaderArray = [] %}
    {% set teamsArray = [] %}
    {% for item in ["Team", "Users"] %}
      {% set teamHeaderArray = (teamHeaderArray.push( { text: item }), teamHeaderArray) %}
    {% endfor %}

    {% for team in teams | sort('team.name') %}
      {% set rowArray = [] %}
      {% set teamLink = "/admin/organisations/" + orgInfo.id + "/teams/" + team.id %}
      {% set rowArray = (rowArray.push( { html: "<a href=" + teamLink +">" + team.name + "</a>" } ), rowArray) %}
      {% set rowArray = (rowArray.push( { text: team.users } ), rowArray) %}
      {% set teamsArray = (teamsArray.push(rowArray), teamsArray) %}
    {% endfor %}

    <div class="table-horizontal-scrolling">
      {{ govukTable({
      classes: "audit",
      firstCellIsHeader: true,
      head: teamHeaderArray,
      rows: teamsArray
      }) }}
    </div>

      <h3>Organisation Users</h3>
      {% if users.length == 0 %}
        <p>There are no users in this organisation.</p>
      {% else %}
        {% set usersArray = [] %}
        {% set usersHeaderArray = [ { text: "User" }, { text: "Email address" }, { text: "Team" } ] %}

        {% for user in users | sort(attribute='username') %}
          {% set rowArray = [] %}
          {% set rowArray = [ { text: (user.firstName + " " + user.lastName) | title }, { text: user.email }, { text: user.team } ] %}
          {% set usersArray = (usersArray.push(rowArray), usersArray) %}
        {% endfor %}
          {{ govukTable({
          classes: "details",
          firstCellIsHeader: false,
          head: usersHeaderArray,
          rows: usersArray
          }) }}
      {% endif %}

    {% set usersPerPage = 5 %}

    {% set startIndex = ((usersMetaData.currentPage - 1) * usersPerPage) + 1 %}
    {% set endIndex = usersMetaData.currentPage * usersPerPage %}
    {% if endIndex > usersMetaData.userCount %}
      {% set endIndex = usersMetaData.userCount %}
    {% endif %}

    <h4>Showing {{ startIndex }}-{{ endIndex }} of {{ usersMetaData.userCount }} records</h4>


    {% set usersPerPage = 5 %}
    {% set pages = usersMetaData.userCount / usersPerPage %}

    {% set paginationArray = [] %}
    {% for i in range(1, pages + 1) -%}
      {% set rowArray = [] %}
      {% set rowArray = { number: i, href: "?page=" + i, attributes: { "onclick": "setCurrentPage()"} } %}
      {% set paginationArray = (paginationArray.push(rowArray), paginationArray) %}
    {%- endfor %}

    {{ govukPagination({
      items: paginationArray
    }) }}
    {% endblock %}

  </div>
</div>

{% endblock %}
