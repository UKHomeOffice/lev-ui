FROM cypress/browsers:node16.5.0-chrome97-ff96 as cypress

RUN apt-get update --quiet -y \
 && apt-get upgrade --quiet -y \
 && apt-get install g++ build-essential -y \
 && apt-get install ca-certificates -y

RUN addgroup --system app \
 && adduser --system --home /app/ --uid 31337 --ingroup app app \
 && chown -R app:app /app/
USER app
WORKDIR /app

FROM cypress as test

COPY --chown=app:app package.json package-lock.json /app/
COPY --chown=app:app assets/ /app/assets/

ENV NODE_ENV production
RUN npm ci
COPY --chown=app:app . /app

USER 31337
CMD ["npm", "run", "test"]
